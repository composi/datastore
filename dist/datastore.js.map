{"version":3,"file":"datastore.js.map","sources":["../node_modules/@composi/get-type/src/index.js","../node_modules/@composi/merge-objects/src/index.js","../node_modules/@composi/observer/src/index.js","../src/index.js"],"sourcesContent":["/**\n * Determine the type of the provided argument.\n * @param {*} value\n * @return {string} string\n */\nexport function getType(value) {\n  // Trap for NaN:\n  if (typeof value === 'number' && isNaN(value)) {\n    return 'nan'\n  } else if (value && value.nodeType === 3) {\n    return 'text'\n  } else if (value && value.nodeType === 1) {\n    return 'element'\n  } else {\n    return new RegExp('\\\\[object (.*)]')\n      .exec(toString.call(value))[1]\n      .toLowerCase()\n  }\n}\n","/**\n * Combine two objects, merging the second into the first. Any properties already existing in the first will be replaced by those of the second. Any properties in the second not in the first will be added to it.\n * This does a deep clone. Sub arrays will be cloned. If arrays consist of objects, those will be cloned. Functions will also be cloned. This also support Maps and Sets.\n * Passing in just one object will return a deep clone of it.\n *\n * @param {Object.<string, any>[]} objects One or more objects to use for merging.\n * @return {Object.<string, any>} Object.<string, any>\n */\n\nexport function mergeObjects(...objects) {\n  // Add empty object to arguments to ensure unique clone:\n  objects.unshift({})\n\n  /**\n   * Create a clone of an object or array.\n   * @param {*} object The object to clone.\n   * @return {Object<string, any>} Object<string, any>\n   */\n\n  function createClone(object, hash = new WeakMap()) {\n    // Deal with primitive types:\n    if (Object(object) !== object) return object\n    // Deal with cyclic references:\n    if (hash.has(object)) return hash.get(object)\n    const result =\n      object instanceof Date\n        ? new Date(object)\n        : object instanceof RegExp\n          ? new RegExp(object.source, object.flags)\n          : object.constructor\n            ? new object.constructor()\n            : Object.create(null)\n    hash.set(object, result)\n    if (object instanceof Map)\n      Array.from(object, ([key, val]) =>\n        result.set(key, createClone(val, hash))\n      )\n    if (object instanceof Set)\n      Array.from(object, val => result.add(createClone(val, hash)))\n    return Object.assign(\n      result,\n      ...Object.keys(object).map(key => ({\n        [key]: createClone(object[key], hash)\n      }))\n    )\n  }\n  // Return cloned copy of merged objects:\n  return objects.reduce((a, b) => Object.assign(a, createClone(b)))\n}\n","/**\n * Observer class providing two methods: watch and send.\n * It also exposes a method for setting state: `setState`.\n * `setState` works just like the same method on Composi class components.\n * When you use `setState` it sends a message to an instance of DataStoreComponent to update itself.\n */\nexport class Observer {\n  constructor() {\n    this.events = {}\n  }\n\n  /**\n   * Method to subscribe to a publishing event.\n   * @param {string} event\n   * @param {Function} callback\n   * @return {void} undefined\n   */\n  watch(event, callback) {\n    if (this.events.hasOwnProperty(event)) {\n      this.events[event].push(callback)\n    } else {\n      this.events[event] = [callback]\n    }\n  }\n\n  /**\n   *\n   * @param {string} event\n   * @param {any} [data]\n   * @return {any[]} events\n   */\n  send(event, data) {\n    // There's no event to send to, so bail out:\n    if (!this.events.hasOwnProperty(event)) {\n      return []\n    }\n    return this.events[event].map(callback => callback(data))\n  }\n\n  /**\n   * Remove an event from queue.\n   * @param {string} event\n   * @return {void} undefined\n   */\n  unwatch(event) {\n    this.events[event]\n  }\n}\n","import { getType } from '@composi/get-type'\nimport { mergeObjects } from '@composi/merge-objects'\nconst EMPTY_OBJECT = {}\nimport { Observer } from '@composi/observer'\n\n/**\n * A Symbol as the property of the dataStore's state. This creates a pseudo-private.\n */\nconst DATASTORE = Symbol()\n\n/**\n * A Symbol as the property of the dataStore's version. This creates a pseudo-private.\n */\nconst VERSION = Symbol('vesion')\n\n/**\n * A Symbol as the property of the dataStore's timestamp. This creates a pseudo-private.\n */\nconst TIMESTAMP = Symbol('timestamp')\n\n/**\n * A class to create a dataStore. This is used in conjunction with DataStoreComponent to create stateless components with external state management through a dataStore.\n */\nexport class DataStore {\n  /**\n   * Constructor for DataStore.\n   * @param {*} data Whatever data you want to store.\n   */\n  constructor(data) {\n    this[DATASTORE] = undefined\n    this.observer = new Observer()\n    this.state = data\n    this.events = {}\n    this.events['dataStoreStateChanged'] = []\n    this[VERSION] = 1\n    this[TIMESTAMP] = new Date().getTime()\n  }\n\n  /**\n   * @method This is a getter to access the component's state using the pseudo-private key dataStore.\n   * @return {boolean | number | string | Object | any[]} The component's state\n   */\n  get state() {\n    return this[DATASTORE]\n  }\n\n  /**\n   * @method This is a setter to define the component's state. It uses the dataStore object as a pseudo-private key. It uses requestAnimationFrame to throttle component updates to avoid layout thrashing.\n   * @param {string | number | boolean | Object | any[]} data Data to set as component state.\n   * @return {void} undefined\n   */\n  set state(data) {\n    this[DATASTORE] = data\n    if (this.events) {\n      Object.keys(this.events).map(event => {\n        if (event.length) {\n          this.send(event, this.state)\n        }\n      })\n    }\n  }\n\n  /**\n   * Get the current version of the dataStore.\n   * @return {number} number\n   */\n  get version() {\n    return this[VERSION]\n  }\n\n  /**\n   * Increase the dataStore version. Use this to update the version, bumping it one version higher.\n   * @return {void} undefined\n   */\n  bumpVersion() {\n    this[VERSION] = this[VERSION] + 1\n  }\n\n  get timestamp() {\n    return this[TIMESTAMP]\n  }\n\n  /**\n   * @method This is a method to send an event with data to a DataStoreComponent that is using a dataStore.\n   * @param {string} event The name of the event that the component is watching.\n   * @param {any} data Any data you want to send to the component.\n   */\n  send(event, data) {\n    if (event === '' || !event) {\n      this.observer.send('dataStoreStateChanged', data)\n    } else if (this.events[event]) {\n      this.observer.send(event, data)\n    }\n  }\n\n  /**\n   * @method This method sets up an observer to listener for the designated event and do something with any data passed along.\n   * @param {string} event The event to watch.\n   * @param {any} cb Any data that the event callback will need to handle.\n   */\n  watch(event, cb) {\n    if (!event) {\n      this.events['dataStoreStateChanged'].push(\n        this.observer.watch('dataStoreStateChanged', cb)\n      )\n    } else if (typeof event === 'function') {\n      this.events['dataStoreStateChanged'].push(\n        this.observer.watch('dataStoreStateChanged', event)\n      )\n    } else {\n      this.events[event] = [this.observer.watch(event, cb)]\n    }\n  }\n\n  /**\n   * @method Method to set a dataStore's state. This accepts simple types or Objects. If updating an array, you can pass in the data and the position (number) in the array to update. Optionally you can pass a callback, which receives the state as its argument. You need to return the state changes in order for the component to be updated.\n   * @example Set state on a dataStore:\n   * \n   * ```\n   * this.setState(true)\n   * this.setState(0)\n   * this.setState({name: 'Joe'})\n   * this.setState([1,2,3])\n   * this.setState(prevState => prevState + 1)\n   ```\n   * @param {string | number | boolean | Object | any[] | Function} data The data to set. If a callback is passed as the argument to execute, it gets passed the previous state as its argument. You need to make sure the callback returns the final state or the component will not update.\n   * @return {void} undefined\n   */\n  setState(data) {\n    if (typeof data === 'function') {\n      let copyOfState\n      if (getType(this.state) === 'array') {\n        copyOfState = JSON.parse(JSON.stringify(this.state))\n      } else if (typeof this.state === 'object') {\n        copyOfState = mergeObjects(EMPTY_OBJECT, this.state)\n      } else {\n        // Handle primitive types:\n        copyOfState = this.state\n      }\n      const newState = data.call(this, copyOfState)\n      if (newState) this.state = newState\n    } else if (getType(this.state) === 'object' && getType(data) === 'object') {\n      const newState = mergeObjects(this.state, data)\n      this.state = newState\n    }\n  }\n\n  /**\n   * Unwatch a custom event. This will not remove the default event--dataStoreStateChanged.\n   * @param {string} event\n   * @return {void} undefined\n   */\n  unwatch(event) {\n    if (event !== 'dataStoreStateChanged') {\n      delete this.events[event]\n      this.observer.unwatch(event)\n    }\n  }\n\n  /**\n   * Saves the current dataStore state in localStorage.\n   * @return {Promise} Promise\n   */\n  putInLocalStorage() {\n    return new Promise((resolve, reject) => {\n      if (this.state) {\n        localStorage.setItem('composi-datastore', JSON.stringify(this.state))\n        localStorage.setItem('composi-datastore-version', this.version + '')\n        localStorage.setItem('composi-datastore-timestamp', this.timestamp)\n        resolve()\n      } else {\n        reject(new Error('Unable to save to localStorage.'))\n      }\n    })\n  }\n\n  /**\n   * Rehydrate the dataStore with whatever was prevously saved from the dataStore in localStorage.\n   * @return {Promise} Promise\n   */\n  getFromLocalStorage() {\n    return new Promise((resolve, reject) => {\n      const state = JSON.parse(localStorage.getItem('composi-datastore'))\n      if (state) {\n        this.state = state\n        resolve()\n      } else {\n        reject(new Error('There was nothing in localStorage to retrieve.'))\n      }\n    })\n  }\n}\n"],"names":["getType","value","isNaN","nodeType","exec","toString","call","toLowerCase","mergeObjects","objects","createClone","object","hash","WeakMap","Object","has","get","result","Date","RegExp","source","flags","constructor","create","set","assign","keys","map","key","unshift","reduce","a","b","Observer","events","watch","event","callback","hasOwnProperty","push","send","data","unwatch","EMPTY_OBJECT","DATASTORE","Symbol","VERSION","TIMESTAMP","DataStore","observer","state","getTime","cb","copyOfState","JSON","parse","stringify","_typeof","newState","Promise","resolve","reject","_this","localStorage","setItem","version","timestamp","Error","getItem","_this2","length","_this3"],"mappings":"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"}